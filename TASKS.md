# 動画生成プログラム タスク管理

## 現在実装済みの機能

- [x] 音声合成（VOICEVOXエンジンを使用）
- [x] 音声ファイルの長さ測定
- [x] 音声長に基づく字幕表示時間の自動調整
- [x] タイムライン管理による音声と字幕の同期
- [x] 上部字幕と下部字幕の連続表示管理
- [x] マルチプロセスによるフレーム生成の高速化
- [x] FFmpegを使用した動画生成
- [x] 設定ファイル（JSON）からの台本読み込み
- [x] keifontフォントの使用

## 直近で解決した問題

- [x] フォントリソースエラーの解決
  - 原因: NotoSansCJKjp-Bold.ttfが見つからなかった
  - 解決: keifont.ttfを使用するように修正
- [x] FFmpegのパス設定
  - 原因: FFmpegが見つからなかった
  - 解決: run.shでFFmpegのパスを追加
- [x] 音声と字幕の同期ずれ
  - 原因: 字幕表示のタイミング管理が不十分だった
  - 解決: 正確なタイムライン生成と各フレームでの表示状態判定を実装
- [x] 字幕の表示タイミングを改善
  - 原因: 下部字幕表示時に上部字幕が消えていた
  - 解決: 上部字幕に展開表示時間（extend_time）を追加し、対応する下部字幕が終わるまで表示を維持

## 今後の課題

- [ ] 字幕の表示効果（フェードイン・アウトなど）の追加
- [ ] 音声・字幕タイミングの微調整パラメータ追加
- [ ] 複数フォントの切り替え対応
- [ ] 字幕のスタイル（色、サイズ、位置）のカスタマイズ
- [ ] 背景画像対応
- [ ] 経過表示のプログレスバー実装
- [ ] エラーハンドリングの強化
- [ ] 台本編集用GUIの開発
- [ ] 生成動画のプレビュー機能

## 使用方法

```bash
cd /Users/hayashimasaki/Documents/auto_video_generator
./run.sh data/learning_efficiency_script.json
```

## 設定ファイル（JSON）の書式

```json
{
  "title": "動画タイトル",
  "duration": 480,
  "voiceActor": "使用する声優名",
  "segments": [
    {
      "segmentId": 1,
      "position": "top",
      "text": "表示するテキスト",
      "voiceText": "読み上げるテキスト",
      "duration": 3
    },
    {
      "segmentId": 2,
      "position": "bottom",
      "text": "表示するテキスト",
      "voiceText": "読み上げるテキスト",
      "duration": 4
    }
    // 以下、同様のセグメント
  ]
}
```

注意: `duration`は参考値として使用されます。実際の表示時間は音声合成後の音声ファイルの長さによって自動調整されます。

## 動作フロー

1. 台本JSONファイルの読み込み
2. 音声合成と音声長測定
3. タイムライン生成
4. フレーム生成
5. 動画生成
6. 音声結合
7. 最終出力

## パフォーマンス最適化

- 並列処理を使ったフレーム生成
- Apple Silicon向けh264_videotoolboxエンコーダの使用
- バッチ処理による効率的なフレーム生成